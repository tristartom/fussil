
Prvildeged program

RUID/EUID
---

RUID: the account calling the program
EUID: the ID the program uses to interact with OS (internal-calls syscalls)

By default: 
- EUID = RUID for normal program
- EUID = root for priviledged program (owner of the program file)

`setuid()`
---

You can use `setuid()` function to change EUID inside the program file.




Privileged programs
===

Motivating application
===

Fine-grained AC
---

A password file storing multiple users' passwords.

File-grained permissions are not expressive enough.

Fine-grained AC
---

* A password file storing Alice's and Bob's passwords. Alice and Bob are group users to the password file owner.
  * If the file's group read permission is 1, Alice can see Alice's password (utility), and Alice can see Bob's password (insecurity).
  * If the file's group read permission is 0, Alice cannot see Alice's password (loss of utility), and Alice cannot see Bob's password (security).
  * So, how to achieve both? A privileged program enforcing fine-grained access control.
  * A privileged program can always access the file, from the OS perspective. It is trusted by end users. Internally, it enforces the access logicâ€”who can see what (part) of the file.
  * How to let a program be able to access a shared password file? Let this program have privilege.
    * Program file owned by a privileged user (root), and when

Privileged program
===

EUID/RUID
---

- Consider Alice runs program "p" which request accessing file "f".
- Bob owns the program file "p".
- If "p" is a normal program: OS sees the file access is from Alice.
- If "p" is a privileged program: OS sees the file access is from Bob.

Demo: `permission-fileio/make turn-priv-program`

Internal design of privileged programs
---

1. authentication
2. fine-grained access control
3. execute the job the user/Alice requests

Revisit shared password file:
---

- normal file-grained access control: a permission (binary 0/1) defined on file f and user type g
- fine-grained access control: a permission (binary 0/1) defined on a line of a file l and a specific account (Alice).

??? fine-grained ACL

setuid program: Downgrading
===

confused deputy bug
===

Misc.
===

Demo
---

normal user: nathan
root user: root

#from nathan
cat file_wo.txt

#from root
sudo su
cat file_wo.txt

#from root, but initiated from nathan
sudo cat file_wo.txt

- how it works internally (sudo cat file_wo.txt)
- nathan>sudo ==> root>cat 
- OS see cat issued from root

Commands on MacOS
---

sudo sysadminctl -addUser username -password 'pw'
sudo sysadminctl -addUser nathan -password '1234'

su - B

dscl . list /Users



